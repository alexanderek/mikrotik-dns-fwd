# MikroTik DNS FWD (Auto-managed)

This repository keeps `/ip dns static` FWD rules in a predictable state on
MikroTik RouterOS. It is intended for setups where DNS forwarding is used to
steer traffic by domain (for example, per VPN or policy route).

---

## ğŸ”§ What this project does

It builds RouterOS-compatible `.rsc` files with `type=FWD` rules. Domain data is
collected and merged from:

  * [https://iplist.opencck.org](https://iplist.opencck.org)
  * [https://github.com/MetaCubeX/meta-rules-dat](https://github.com/MetaCubeX/meta-rules-dat) (geosite)

The lists are regenerated by GitHub Actions and loaded on RouterOS via a loader
script. Manual DNS rules are not touched.

---

## ğŸ§  Key concepts

### 1. Source of truth = GitHub

All domain lists are generated in GitHub and stored in `for_scripts/*.rsc`.

RouterOS does not generate domains; it only downloads and applies them.

---

### 2. Namespacing: `dnsfwd:auto:*`

All automatically managed rules use comments like:

```routeros
dnsfwd:auto:<resource>
```

Examples:

* `dnsfwd:auto:openai`
* `dnsfwd:auto:tiktok`

This namespace is used for cleanup and sync while allowing manual rules to
coexist.

Anything **without** this prefix is treated as manual and left alone.

---

### 3. Manual rules are sacred ğŸ›¡ï¸

You can safely add your own rules, for example:

```routeros
/ip dns static add \
  name=manual.example \
  type=FWD \
  forward-to=dns_example \
  address-list=dnsfwd_example \
  comment="MANUAL_DO_NOT_TOUCH"
```

These rules will **never** be removed or modified by this system.

---

## ğŸ”„ SyncMode

The loader script supports two modes:

### `SyncMode="add"` (default, safest)

* Only adds missing entries
* Never deletes anything
* Ideal for first deployment or cautious setups

### `SyncMode="sync"`

* Removes **only** entries with:

  * `comment=dnsfwd:auto:<resource>`
  * within the current `AddressList`
* Then applies the freshly downloaded list
* Manual rules are preserved

This gives **true reconciliation** without risk.

---

## ğŸŒ Multiple regions / forwarders

Typical use case:

* Region A domains â†’ Forwarder A â†’ `dns_example_a`
* Region B domains â†’ Forwarder B â†’ `dns_example_b`

This is handled by running **two independent loader scripts** with different
parameters.

---

## ğŸ§¾ Prebuilt loader scripts

Located in `routeros/`:

* `loader_eu.rsc`
* `loader_ru.rsc`

These are **examples**. Copy/rename and adjust to your environment.

They differ **only** by:

* `AddressList`
* `ForwardTo`

---

## â–¶ï¸ Example loader (excerpt)

```routeros
:global AddressList "dnsfwd_example"
:global ForwardTo "dns_example"
:global SyncMode "sync"

:local baseUrl "https://raw.githubusercontent.com/alexanderek/MikroTik_DNS_FWD/refs/heads/main/for_scripts"
```

---

## â±ï¸ Scheduler example

```routeros
/system scheduler
add name=dnsfwd-a interval=1d on-event="/system/script/run loader_example_a"
add name=dnsfwd-b interval=1d on-event="/system/script/run loader_example_b"
```

---

## ğŸ¤– GitHub Actions

The workflow regenerates `for_scripts/*.rsc`, clears prior artifacts, validates
output, prevents concurrent runs (`concurrency`), and rebases before pushing to
`main`.

The workflow is autonomous and does not require manual intervention.

---

## âœ… Design goals

* âœ… Idempotent
* âœ… Safe for production
* âœ… Manual rules preserved
* âœ… Predictable sync
* âœ… Minimal RouterOS logic
* âœ… GitHub as single source of truth

---

## ğŸ“‚ Domain lists index

`for_scripts/` is large and GitHub may truncate the directory view in the web UI.
Use the index files for a full listing:

* [for_scripts/index.md](for_scripts/index.md)
* [for_scripts/index.json](for_scripts/index.json)

---

## âš ï¸ Notes

* Some `fetch` 404 logs are expected due to `partN` probing
* These are harmless and can be filtered via RouterOS logging if desired

---

## ğŸ“Œ TL;DR

GitHub generates â†’ MikroTik downloads â†’
`dnsfwd:auto:*` is managed â†’ everything else is yours.

Safe. Boring. Reliable.

---
